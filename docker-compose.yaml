networks:
  app-network:
    driver: bridge
    external: true

services:

  # litellm:
  #   image: ghcr.io/berriai/litellm:latest # Or build from a Dockerfile
  #   ports:
  #     - "4001:4000"
  #   volumes:
  #     - ./litellm_config.yaml:/app/config.yaml # Mount your config file
  #   environment:
  #     - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY}
  #     - LITELLM_SALT_KEY=${LITELLM_SALT_KEY}

  #     - AZURE_OPENAI_API_KEY=""
  #     - AZURE_OPENAI_ENDPOINT=""
  #     - AZURE_OPENAI_API_VERSION=""
  #     - AZURE_API_BASE=""
  #     - AZURE_OPENAI_AD_TOKEN=""

  #     # Add other LLM API keys as needed
  #     # - OPENAI_API_KEY=${OPENAI_API_KEY}
  #   command: ["litellm", "--config", "/app/config.yaml", "--port", "4000"]

 

  pg_db_ai:
    image: postgres:18.0-alpine
    container_name: pg_db_ai
    hostname: pg_db_ai
    environment:
      - POSTGRES_USER=transcription
      - POSTGRES_PASSWORD=fK7-SEqRwMsSREpAHBnU
      - POSTGRES_DB=openwebui 
    volumes:
      - ./data/pgdata-lex:/var/lib/postgresql/18/docker
      # - ./data/pgdata-latest:/var/lib/postgresql/18/docker
    ports:
      - "5433:5432"
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U transcription -d openwebui"]
      interval: 10s
      timeout: 5s
      retries: 5

  # grafana:
  #   image: grafana/grafana-oss
  #   container_name: grafana
  #   hostname: grafana
  #   ports:
  #     - "3000:3000"
  #   environment:
  #     - GF_SECURITY_ADMIN_USER=admin
  #     - GF_SECURITY_ADMIN_PASSWORD=supersecure123
  #   volumes:
  #     - ./data/grafana-storage:/var/lib/grafana
  #   extra_hosts:
  #     - "host.docker.internal:host-gateway"
  #   restart: always
  #   networks:
  #     - app-network
  #   depends_on:
  #     - pg_db_ai
  #   links:
  #     - pg_db_ai



  # prometheus_ai:
  #   image: prom/prometheus:latest
  #   container_name: prometheus_ai
  #   hostname: prometheus_ai
  #   volumes:
  #     - ./configs/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
  #     - ./configs/prometheus/web-config.yml:/etc/prometheus/auth/web-config.yml:ro
  #   ports:
  #     - "9090:9090"
  #   depends_on:
  #     - otel_collector_ai
  #     - jaeger_ai
  #   links:
  #     - otel_collector_ai
  #     - jaeger_ai
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--web.config.file=/etc/prometheus/auth/web-config.yml'
  #   extra_hosts:
  #     - "host.docker.internal:host-gateway"
  #   restart: always
  #   networks:
  #     - app-network
 
  # jaeger_ai:
  #   image: jaegertracing/all-in-one:latest
  #   container_name: jaeger_ai
  #   hostname: jaeger_ai
  #   # ports:
  #   #   - "16686:16686"  # Web UI
  #   #   - "14251:14250"  # gRPC
  #   #   - "14269:14268"  # HTTP thrift
  #   #   - "9412:9411"    # Zipkin compatible
  #   expose:
  #     - 14250
  #     - 16686
  #     - 14268
  #     - 9411
  #   networks:
  #     - app-network
  #   restart: always 
  #   links:
  #     - otel_collector_ai
  #   depends_on:
  #     - otel_collector_ai


  # otel_collector_ai:
  #   container_name: otel_collector_ai
  #   hostname: otel_collector_ai
  #   image: otel/opentelemetry-collector:0.60.0
  #   command: ["--config=/etc/otel-collector-config.yaml"]
  #   # user: root # required for reading docker container logs
  #   volumes:
  #     - ./configs/otel-collector-config-app.yaml:/etc/otel-collector-config.yaml
  #   environment:
  #     - OTEL_RESOURCE_ATTRIBUTES=host.name=otel-host,os.type=linux
  #   ports:
  #     # - "1777:1777"     # pprof extension
  #     - "4317:4317"     # OTLP gRPC receiver
  #     - "4318:4318"     # OTLP HTTP receiver
  #     - "8888:8888"     # OtelCollector internal metrics
  #     - "8889:8889"     # signoz spanmetrics exposed by the agent
  #     # - "9411:9411"     # Zipkin port
  #     - "13133:13133"   # health check extension
  #     - "14250:14250"   # Jaeger gRPC
  #     - "14268:14268"   # Jaeger thrift HTTP
  #     # - "55678:55678"   # OpenCensus receiver
  #     # - "55679:55679"   # zPages extension
  #   restart: unless-stopped
  #   extra_hosts:
  #     - "host.docker.internal:host-gateway" 
  #   networks:
  #     - app-network


  ollama:
    volumes:
      - ./data/ollama:/root/.ollama
    container_name: ollama
    # pull_policy: always
    tty: true
    restart: unless-stopped
    image: ollama/ollama:${OLLAMA_DOCKER_TAG-latest}
    networks:
      - app-network

  open-webui:
    build:
      context: .
      args:
        OLLAMA_BASE_URL: '/ollama'
      dockerfile: Dockerfile
    image: ghcr.io/open-webui/open-webui:${WEBUI_DOCKER_TAG-main}
    container_name: open-webui
    # command: "sh -c 'pip install aiosmtplib"
    command: 
      sh -c "pip install aiosmtplib"
    env_file:
      - .env
    volumes:
      - .:/app # <â€” edit locally, container runs your code
      # - ./webui-data:/app/backend/data      # persistent app data (users, settings, etc.)
      - ./webui-cache:/root/.cache          # optional cache (models, etc.)
    # # volumes:
      - open-webui:/app/backend/data
    # volumes:
    #   - ./open-webui-data:/app/backend/data
    #   - ./backend:/app/backend 
    #   - ./build:/app/build
    #   - ./CHANGELOG.md:/app/CHANGELOG.md
    #   # - ./package.jso/n:/app/package.json
    #   # - ./.env:/app/.env
      - ./static/static:/app/build/static
    #   # - ./:/app/

    # depends_on:
    #   - ollama
    #   - pg_db_ai
    #   - redis

    
    links:
      - pg_db_ai
      - redis_ai
      - ollama
      # - otel_collector_ai
    depends_on:
      - pg_db_ai
      - redis_ai
      - ollama
      # - otel_collector_ai
    ports:
      # - ${OPEN_WEBUI_PORT-3000}:8080
      - "${WEBUI_PORT:-8080}:8080"
    environment:
      - 'ENV=${ENV:-prod}'
      - 'WEBUI_NAME=${WEBUI_NAME:-AI Legal Assistant}'
      - 'WEBUI_PORT=${WEBUI_PORT}'
      - 'BASE_URL=${WEBUI_URL:-https://lexluma.com}'
      - 'CORS_ALLOW_ORIGIN=${CORS_ALLOW_ORIGIN}'
      - 'WEBUI_URL=${WEBUI_URL:-https://lexluma.com}'
      - 'ENABLE_OAUTH_PERSISTENT_CONFIG=false'     # so env changes apply during testing
      - 'OLLAMA_BASE_URL=${OLLAMA_BASE_URL}'  #
      - 'OLLAMA_API_KEY=${OLLAMA_API_KEY}'  #
      - 'WEBUI_SECRET_KEY=${SECRET_KEY}'  # set in .env file
      # - 'ENABLE_OTEL_METRICS=false'
      # - 'OTEL_EXPORTER_OTLP_INSECURE=true' # Use insecure connection for OTLP, remove in production
      # - 'OTEL_EXPORTER_OTLP_ENDPOINT=http://grafana:4317'
      # - 'OTEL_SERVICE_NAME=open-webui'
      - 'DATABASE_URL=${DATABASE_URL:-postgresql://transcription:fK7-SEqRwMsSREpAHBnU@pg_db_ai/webui}'
      # - 'VECTOR_DB=pgvector'

      - USER_AGENT=${USER_AGENT:-Open WebUI (https://openwebui.ai)}
      - ENABLE_WEBSOCKET_SUPPORT="true"
      - WEBSOCKET_MANAGER="redis"
      - WEBSOCKET_REDIS_URL="redis://redis_ai:6379/1"
      - REDIS_KEY_PREFIX="open-webui"
      - ENABLE_OAUTH_SIGNUP=${ENABLE_OAUTH_SIGNUP:-True}
      - ENABLE_SIGNUP_PASSWORD_CONFIRMATION=${ENABLE_SIGNUP_PASSWORD_CONFIRMATION:-True}
      - ENABLE_SIGNUP=True
      - ENABLE_CHANNELS=${ENABLE_CHANNELS:-True}
      - ENABLE_AUDIT_LOGGING=${ENABLE_AUDIT_LOGGING:-True}
      - DEFAULT_PROMPT_SUGGESTIONS=${DEFAULT_PROMPT_SUGGESTIONS:-[]}
      - WEBUI_BANNERS=${WEBUI_BANNERS:-[]}
      - ENABLE_VERSION_UPDATE_CHECK=${ENABLE_VERSION_UPDATE_CHECK:-True} 
      - ENABLE_COMMUNITY_SHARING=${ENABLE_COMMUNITY_SHARING:-True}
      - GLOBAL_LOG_LEVEL=${GLOBAL_LOG_LEVEL:-ERROR}

    
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8080/"]
      interval: 15s
      timeout: 5s
      retries: 20
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    
    extra_hosts:
      - host.docker.internal:host-gateway
    restart: unless-stopped
    networks:
      - app-network


  redis_ai:
    image: redis:alpine
    container_name: redis_ai
    hostname: redis_ai
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "6378:6379"
    expose:
      - "6379"
    command: [
      "redis-server",
      "--requirepass", "${REDIS_PASSWORD:-}", 
      "--masteruser", "${REDIS_USER:-}", 
      "--masterauth", "${REDIS_PASSWORD:-}" 
    ]
    environment:
      - REDIS_USER=${REDIS_USER:-}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    volumes:
      - ./data/redis/data:/data
      - ./data/redis/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      - app-network
    extra_hosts:
      - "google.com:8.8.8.8"


  redis_old:
    image: valkey/valkey:9.0-alpine3.22
    container_name: redis-valkey
    hostname: redis-valkey
    volumes:
      - ./data/redis-data:/data
    command: "valkey-server --save 30 1"
    healthcheck:
      test: "[ $$(valkey-cli ping) = 'PONG' ]"
      start_period: 5s
      interval: 1s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
      - DAC_OVERRIDE
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"
    networks:
      - app-network

  # redis-master_ai:
  #   image: redis:7
  #   container_name: redis-master_ai
  #   hostname: redis-master_ai
  #   # ports:
  #   #   - "6379:6379"
  #   expose:
  #     - 6379
  #   networks:
  #     - app-network
  #   restart: unless-stopped
  #   volumes:
  #     - ./configs/redis/master:/usr/local/etc/redis
  #     - ./data/redis/master-data:/data
  #   command: ["redis-server", "/usr/local/etc/redis/redis.conf"] 

  #   extra_hosts:
  #    - "google.com:142.250.190.78"


  # redis-sentinel_ai:
  #   image: redis:7
  #   container_name: redis-sentinel_ai
  #   hostname: redis-sentinel_ai
  #   depends_on:
  #     - redis-master_ai
  #   links:
  #     - redis-master_ai
  #   # ports:
  #   #   - "26379:26379"
  #   expose:
  #     - 26379
  #   networks:
  #     - app-network
  #   restart: unless-stopped
  #   volumes:
  #     - ./configs/redis/sentinel-data:/usr/local/etc/redis
  #     - ./data/redis/sentinel-data:/data
  #   command: ["redis-server", "/usr/local/etc/redis/sentinel.conf", "--sentinel"]
  #   extra_hosts:
  #     # - "host.docker.internal:host-gateway"
  #     - "google.com:142.250.190.78"


volumes:
  open-webui: {}
  pgdata: {}